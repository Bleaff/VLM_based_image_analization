# VLM Microservice (Qwen3-VL) -- Backend Architecture & Usage Guide

## Overview

This project provides a modular microservice built around **Qwen3-VL**
running through **Ollama**.\
–°–µ—Ä–≤–∏—Å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç: - –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, - —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã, -
–∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞–π–ø–ª–∞–π–Ω—ã, - –ø–æ—Ç–æ–∫–æ–≤—ã–µ –∏ –Ω–µ–ø–æ—Ç–æ–∫–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã, - –º–Ω–æ–≥–æ—Ç—É—Ä–æ–≤—ã–π
–¥–∏–∞–ª–æ–≥ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è.

–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (`config/*.yml`), —á—Ç–æ–±—ã
–∏–∑–±–µ–≥–∞—Ç—å –º–∞–≥–∏—á–µ—Å–∫–∏—Ö —Å—Ç—Ä–æ–∫ –∏ –ø–æ–∑–≤–æ–ª–∏—Ç—å –ª–µ–≥–∫–æ –º–µ–Ω—è—Ç—å –ª–æ–≥–∏–∫—É.

------------------------------------------------------------------------

## Features

-   üîå **FastAPI backend**
-   ü§ñ **Qwen3-VL 8B Vision Language Model** (—á–µ—Ä–µ–∑ Ollama)
-   üîÑ **–°—Ç—Ä–∏–º–æ–≤—ã–π –∏ –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã**
-   üß© **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ –ø–∞–π–ø–ª–∞–π–Ω—ã** —á–µ—Ä–µ–∑ YAML
-   üóÇ **–ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** (—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ—ë–≤)
-   üñº **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (Base64 / multipart)**

------------------------------------------------------------------------

## Architecture

    /app
     ‚îú‚îÄ‚îÄ api/               # HTTP endpoints
     ‚îú‚îÄ‚îÄ core/              # –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞, –æ–±—Ä–∞–±–æ—Ç–∫–∞ —à–∞–≥–æ–≤
     ‚îú‚îÄ‚îÄ llm/               # –æ–±—ë—Ä—Ç–∫–∞ Ollama + Qwen
     ‚îú‚îÄ‚îÄ pipeline/          # –ø–∞–π–ø–ª–∞–π–Ω—ã, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
     ‚îú‚îÄ‚îÄ config/            # YAML –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
     ‚îú‚îÄ‚îÄ utils/             # helpers
     ‚îú‚îÄ‚îÄ main.py            # FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    /config
     ‚îú‚îÄ‚îÄ prompts.yml        # —Å–∏—Å—Ç–µ–º–Ω—ã–µ + —Ä–æ–ª–µ–≤—ã–µ –ø—Ä–æ–º–ø—Ç—ã
     ‚îú‚îÄ‚îÄ pipelines.yml      # –ª–æ–≥–∏–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
    README.md
    Dockerfile
    docker-compose.yml

### Component responsibilities

  Component       Responsibility
  --------------- -------------------------------------------------
  **api/**        HTTP endpoints `/analyze`, `/stream`, `/health`
  **core/**       –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–∏–∞–ª–æ–≥–∞, –≤–∞–ª–∏–¥–∞—Ü–∏—è
  **llm/**        –û–±—ë—Ä—Ç–∫–∞ Ollama API (stream / no-stream)
  **pipeline/**   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ request_type
  **config/**     YAML –∫–æ–Ω—Ñ–∏–≥–∏ (–ø—Ä–æ–º–ø—Ç—ã, —Ä–æ–ª–∏, –ø–∞–π–ø–ª–∞–π–Ω—ã)
  **utils/**      –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –ø–∞—Ä—Å–∏–Ω–≥ JSON

------------------------------------------------------------------------

## Example: Request flow

1.  –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ + `request_type="diagnosis_start"`
2.  –°–µ—Ä–≤–∏—Å –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏–∑ `config/prompts.yml`
3.  –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ Qwen3-VL
4.  –ú–æ–¥–µ–ª—å –∑–∞–¥–∞—ë—Ç 2--3 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞
5.  –ö–ª–∏–µ–Ω—Ç –æ—Ç–≤–µ—á–∞–µ—Ç ‚Üí `request_type="followup"`
6.  –ü–æ—Å–ª–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–≥–æ —á–∏—Å–ª–∞ —à–∞–≥–æ–≤ ‚Üí –≤—ã–¥–∞—ë—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –±–ª–æ–∫ *(3
    –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è + –æ—Ç–ª–∏—á–∏—è + —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)*

------------------------------------------------------------------------

## Endpoints

### `POST /analyze`

–ù–µ–ø–æ—Ç–æ–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å.

Request:

``` json
{
  "image_base64": "<...>",
  "history": [],
  "request_type": "diagnosis_start"
}
```

Response:

``` json
{
  "type": "questions",
  "questions": ["–ö–∞–∫ –¥–∞–≤–Ω–æ –ø–æ—è–≤–∏–ª–æ—Å—å?", "–ï—Å—Ç—å –ª–∏ –∑—É–¥?"]
}
```

------------------------------------------------------------------------

### `POST /stream`

–ü–æ—Ç–æ–∫–æ–≤—ã–π –≤—ã–≤–æ–¥.

Server-Sent Events (SSE).

------------------------------------------------------------------------

### `POST /reset`

–°–±—Ä–æ—Å –¥–∏–∞–ª–æ–≥–∞.

------------------------------------------------------------------------

## Configuration

### prompts.yml

``` yaml
system:
  diagnosis: |
    –¢—ã ‚Äî –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ù–µ —Å—Ç–∞–≤—å –¥–∏–∞–≥–Ω–æ–∑–æ–≤, —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è.
    –í—Å–µ–≥–¥–∞ —É—Ç–æ—á–Ω—è–π 2‚Äì3 —Å–∏–º–ø—Ç–æ–º–∞.
pipeline_roles:
  followup: |
    –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã –∏ —É—Ç–æ—á–Ω—è–π –¥–∞–ª—å—à–µ.
```

### pipelines.yml

``` yaml
start:
  steps:
    - apply_system_prompt: diagnosis
    - ask_questions: 3
followup:
  steps:
    - analyze_answers: true
    - maybe_finish: true
```

------------------------------------------------------------------------

## Local Run

### 1. Install Ollama and Qwen3-VL

``` bash
curl -fsSL https://ollama.com/install.sh | sh
ollama pull qwen3-vl:8b
```

### 2. Build & Run backend

#### Docker

``` bash
docker-compose up --build
```

#### Manual

``` bash
pip install -r requirements.txt
uvicorn app.main:app --reload
```

------------------------------------------------------------------------

## Example: Full Usage

### Step 1 --- send image

``` bash
curl -X POST http://localhost:8000/analyze   -H "Content-Type: application/json"   -d '{
        "image_base64": "<encoded>",
        "request_type": "diagnosis_start"
      }'
```

### Step 2 --- send answers

``` bash
curl -X POST http://localhost:8000/analyze   -H "Content-Type: application/json"   -d '{
        "answers": ["2 –¥–Ω—è", "–∑—É–¥ –Ω–µ–±–æ–ª—å—à–æ–π"],
        "request_type": "followup"
      }'
```

### Step 3 --- final output

``` json
{
  "type": "final",
  "diagnoses": ["–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π –¥–µ—Ä–º–∞—Ç–∏—Ç", "–ì—Ä–∏–±–∫–æ–≤–∞—è –∏–Ω—Ñ–µ–∫—Ü–∏—è", "–£–∫—É—Å—ã –Ω–∞—Å–µ–∫–æ–º—ã—Ö"],
  "differences": "...",
  "recommendations": "..."
}
```

------------------------------------------------------------------------

## Video Demo (optional)

–ó–∞–ø–∏—à–∏—Ç–µ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤–∏–¥–µ–æ: - –∫–∞–∫ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–µ—Ä–≤–∏—Å, - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
—Ñ–æ—Ç–æ, - –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–∏–∞–ª–æ–≥.

------------------------------------------------------------------------

## License

MIT
